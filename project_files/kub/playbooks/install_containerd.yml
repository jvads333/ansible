---
- name: Install containerd and fixed nerdctl artifact (minimal)
  hosts: vm_defs
  become: yes
  gather_facts: yes

  tasks:
    - name: Install containerd and tools
      apt:
        name:
          - containerd
          - wget
          - tar
        state: present
        update_cache: yes

    - name: Ensure containerd is started
      systemd:
        name: containerd
        state: started
        enabled: yes
        daemon_reload: yes

    - name: Download fixed nerdctl tarball (amd64)
      get_url:
        url: "https://github.com/containerd/nerdctl/releases/download/v2.2.0/nerdctl-2.2.0-linux-amd64.tar.gz"
        dest: /tmp/nerdctl-2.2.0-linux-amd64.tar.gz
        mode: '0644'
      args:
        timeout: 180

    - name: Extract nerdctl to /usr/local/bin
      unarchive:
        src: /tmp/nerdctl-2.2.0-linux-amd64.tar.gz
        dest: /usr/local/bin
        remote_src: yes
        creates: /usr/local/bin/nerdctl

    - name: Ensure nerdctl is executable
      file:
        path: /usr/local/bin/nerdctl
        mode: '0755'

    - name: Verify nerdctl version
      command: /usr/local/bin/nerdctl --version
      register: nerdctl_ver
      changed_when: false
      failed_when: false
    - name: Download CNI plugins (amd64 v1.8.0)
      get_url:
        url: "https://github.com/containernetworking/plugins/releases/download/v1.8.0/cni-plugins-linux-amd64-v1.8.0.tgz"
        dest: /tmp/cni-plugins-v1.8.0.tgz
        mode: '0644'
      args:
        timeout: 120

    - name: Ensure /opt/cni/bin exists
      file:
        path: /opt/cni/bin
        state: directory
        mode: '0755'

    - name: Extract CNI plugins v1.8.0 into /opt/cni/bin
      unarchive:
        src: /tmp/cni-plugins-v1.8.0.tgz
        dest: /opt/cni/bin
        remote_src: yes
        creates: /opt/cni/bin/bridge

    - name: Verify bridge plugin is present
      stat:
        path: /opt/cni/bin/bridge
      register: bridge_stat

    - name: Fail if CNI plugin bridge is missing
      fail:
        msg: "CNI plugin 'bridge' missing at /opt/cni/bin â€” extraction failed or wrong URL."
      when: not bridge_stat.stat.exists


    - name: Run hello-world to verify installation
      shell: /usr/local/bin/nerdctl run --rm hello-world
      register: hello_out
      failed_when: hello_out.rc != 0

    - name: Show verification output
      debug:
        msg:
          - "nerdctl: {{ nerdctl_ver.stdout | default('unknown') }}"
          - "hello-world output: {{ hello_out.stdout | default('') }}"
