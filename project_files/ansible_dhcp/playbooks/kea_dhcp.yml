---
- name: Build dhcp_reservations on control node
  hosts: localhost
  gather_facts: false
  vars:
    vm_group: vm_defs

  tasks:
    - name: Initialize dhcp_reservations
      set_fact:
        dhcp_reservations: []

    - name: Build reservations from inventory
      set_fact:
        dhcp_reservations: "{{ dhcp_reservations + [ {
            'mac': hostvars[item].mac | default(''),
            'ip': hostvars[item].vm_ip | default(''),
            'hostname': hostvars[item].inventory_hostname | default(item)
        } ] }}"
      loop: "{{ groups[vm_group] | default([]) }}"
      when: groups[vm_group] is defined

    - name: Show built reservations
      debug:
        var: dhcp_reservations

- name: Deploy Kea DHCP to DHCP servers
  hosts: dhcp
  become: true
  roles:
    - role: kea_dhcp_minimal
      vars:
        dhcp_reservations: "{{ hostvars['localhost'].dhcp_reservations }}"
