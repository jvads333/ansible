- name: Setup webserver to serve NFS mount
  hosts: web
  become: true
  vars_files:
    - ../group_vars/nfs.yml

  vars:
    nginx_site_path: /etc/nginx/sites-available/nfs_site
    nginx_site_link: /etc/nginx/sites-enabled/nfs_site

  tasks:
    - name: Install nginx
      apt:
        name: nginx
        state: present
        update_cache: true

    - name: Ensure the NFS mount exists and is mounted (idempotent)
      mount:
        path: "{{ mount_point }}"
        src: "{{ hostvars['nfs'].ansible_host }}:{{ nfs_share_path }}"
        fstype: nfs
        opts: defaults,_netdev
        state: mounted

    - name: Create nginx site file to serve the NFS mount (directory listing)
      copy:
        dest: "{{ nginx_site_path }}"
        content: |
          server {
              listen 80 default_server;
              listen [::]:80 default_server;
              server_name _;
              root {{ mount_point }};
              index index.html;
              autoindex on;
              autoindex_exact_size off;
              autoindex_localtime on;

              location / {
                  # let nginx show directory listing and files from NFS
                  try_files $uri $uri/ =404;
              }

              # do not expose . files (optional)
              location ~ /\. {
                  deny all;
              }
          }
        owner: root
        group: root
        mode: '0644'
      notify: Reload nginx

    - name: Remove default site symlink if present
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: Reload nginx

    - name: Ensure site symlink is present
      file:
        src: "{{ nginx_site_path }}"
        dest: "{{ nginx_site_link }}"
        state: link
      notify: Reload nginx

    - name: Test nginx configuration
      command: nginx -t
      register: nginx_test
      changed_when: false
      failed_when: nginx_test.rc != 0

    - name: Ensure nginx is started and enabled
      service:
        name: nginx
        state: started
        enabled: yes

    - name: Wait for nginx to be responsive on port 80
      wait_for:
        port: 80
        host: 127.0.0.1
        timeout: 10

  handlers:
    - name: Reload nginx
      service:
        name: nginx
        state: reloaded
