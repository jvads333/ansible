---
- name: Build dhcp_reservations on control node
  hosts: localhost
  gather_facts: false
  vars:
    vm_group: vm_defs

  tasks:
    - name: Initialize dhcp_reservations
      set_fact:
        dhcp_reservations: []

    - name: Build reservations (Kea format) from inventory (vm_defs)
      set_fact:
        dhcp_reservations: >-
          {{ dhcp_reservations + [ {
            'hw-address': hostvars[item].mac | default(''),
            'ip-address' : hostvars[item].vm_ip | default(''),
            'hostname'   : hostvars[item].inventory_hostname | default(item)
          } ] }}
      loop: "{{ groups[vm_group] | default([]) }}"
      when: groups[vm_group] is defined

    - name: Debug - show built dhcp_reservations
      debug:
        var: dhcp_reservations


- name: Deploy Kea DHCP server (distro version only)
  hosts: dhcp
  become: true
  vars:
    kea_subnet: "10.10.10.0/24"
    kea_pool: "10.10.10.100 - 10.10.10.200"
    kea_gateway: "10.10.10.10"
    kea_dns: "8.8.8.8,8.8.4.4"

    kea_conf_path: /etc/kea/kea-dhcp4.conf
    kea_conf_template: kea-dhcp4.conf.j2

    # hardcoded distro service name (NO ISC)
    kea_service_name: "kea-dhcp4-server"

  tasks:
    - name: Ensure apt cache updated
      apt:
        update_cache: yes

    - name: Install pure Kea packages
      apt:
        name:
          - kea-common
          - kea-dhcp4-server
        state: present

    - name: Ensure kea config directory exists
      file:
        path: "{{ kea_conf_path | dirname }}"
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Deploy kea config (template)
      template:
        src: "{{ kea_conf_template }}"
        dest: "{{ kea_conf_path }}"
        owner: root
        group: root
        mode: '0644'
      vars:
        dhcp_reservations: "{{ hostvars['localhost'].dhcp_reservations | default([]) }}"
      notify: Restart kea

    - name: Reload systemd (safe)
      command: systemctl daemon-reload
      changed_when: false

    - name: Enable & start Kea DHCP service
      service:
        name: "{{ kea_service_name }}"
        enabled: yes
        state: started
      register: kea_service_result

    - name: Debug - kea service result
      debug:
        var: kea_service_result

    - name: Show UDP listeners (diagnostic) - for DHCP port 67
      command: ss -unlp
      register: ss_out
      changed_when: false

    - name: Debug - lines with :67 (diagnostic)
      debug:
        var: ss_out.stdout_lines | select('search', ':67') | list

  handlers:
    - name: Restart kea
      service:
        name: "{{ kea_service_name }}"
        state: restarted
