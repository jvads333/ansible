---
# kea_dhcp_minimal tasks
- name: Ensure required packages for repo setup present
  apt:
    name:
      - curl
      - gnupg
      - apt-transport-https
      - ca-certificates
    state: present
    update_cache: yes
  become: true

- name: Add ISC Cloudsmith repository (setup script) if not already added
  command: >
    /bin/sh -c "curl -1sLf 'https://dl.cloudsmith.io/public/isc/kea-3-0/setup.deb.sh' | sudo -E bash"
  args:
    creates: /etc/apt/sources.list.d/isc_kea-3-0.list
  become: true

- name: Update apt cache
  apt:
    update_cache: yes
  become: true

- name: Install isc-kea metapackage
  apt:
    name: isc-kea
    state: present
  become: true

# Detect service units BEFORE template so handler has the correct service name
- name: Detect Kea-related systemd units
  command: >
    /bin/sh -lc "systemctl list-units --all --type=service --no-legend | awk '{print \$1}' | grep -i kea || true"
  register: kea_units
  changed_when: false
  become: true

- name: Set kea_service_name fact (first detected) or fallback
  set_fact:
    kea_service_name: >-
      {{
        (kea_units.stdout_lines[0]
         if (kea_units.stdout_lines is defined and kea_units.stdout_lines | length > 0)
         else 'isc-kea-dhcp4-server.service')
      }}

- name: Debug detected kea units
  debug:
    msg:
      - "Detected kea units: {{ kea_units.stdout_lines | default([]) }}"
      - "Using kea_service_name={{ kea_service_name }}"

# Deploy configuration template (notify handler)
- name: Deploy kea-dhcp4.conf
  template:
    src: kea-dhcp4.conf.j2
    dest: "{{ kea_conf_path }}"
    mode: '0644'
  notify: Restart kea
  become: true

- name: Ensure selected Kea service enabled and started
  service:
    name: "{{ kea_service_name }}"
    enabled: yes
    state: started
  become: true

# Diagnostic: show UDP listeners (so play output includes whether :67 is bound)
- name: Show UDP listeners (ss)
  command: ss -unlp
  register: ss_out
  changed_when: false
  become: true

- name: Debug ss output lines containing :67
  debug:
    var: ss_out.stdout_lines | select('search', ':67') | list
